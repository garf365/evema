{% extends 'organizer/base.html' %}

{% load volunteer %}

{% block title %}{{ event.name }} - duo{% endblock %}

{% block content %}

<div name="volunteers">
<form action="{% url 'organizer:duo' event.slug %}" method="post" id="duoform">
  {{ form.non_field_errors }}

  {% csrf_token %}
  {% for hidden in form.hidden_fields %}
    {{ hidden }}
  {% endfor %}
 <table class="table table-striped table-bordered table-hover table-sm">
  <thead class="thead-dark">
   <tr scope="row">
    <th scope="col">Bénévole</th>
    <th scope="col">Demande</th>
    <th scope="col">Duo</th>
   </tr>
  </thead>
  <tbody>
  {% for field in form.visible_fields %}
   <tr scope="row">
    <td scope="col">
     {{ field.label_tag }} 
    </td>
    <td scope="col" {% if field.field.availability.volunteerfriendshipwaiting %} class="waiting">
        <span class="waiting">{{ field.field.availability.volunteerfriendshipwaiting }} </span>
        {% else %}
        >
        {% endif %}
    </td>
    <td scope="col">
        {{ field.errors }}
        {{ field }}
    </td>
  </tr>
  {% endfor %}
  </tbody>
 </table>
  <div class="text-center">
    <button type="submit" class="btn btn-primary btn-lg px-5">
      Sauvegarder
    </button>
  </div>
</form>
</div>

{% endblock %}

{% block extra_script %}
<script>
const initial = { 
{% spaceless %}{% for field in form.visible_fields %}{% if field.value %}"{{ field.name }}": "{{ field.value.0 }}",{% endif %}
{% endfor %}{% endspaceless %}
};
let previous = {...initial};
$("select").on('change', function(e) {
  $(this).closest("tr").removeClass("error");

  let is_modified = false;
  if (initial[this.name]) {
    is_modified = this.value != initial[this.name];
  } else {
    is_modified = !!this.value;
  }

  if (is_modified) {
    $(this).closest("tr").addClass("modified");
  }
  else {
    $(this).closest("tr").removeClass("modified");
  }

  if (e.originalEvent && e.originalEvent.isTrusted) {
    if (this.value && this.value != "sup") {
      duo = $('select[name="'+this.value+'"]');
      if (duo.val() != '' && duo.val() != this.name) {
        if (!window.confirm("Un duo différent est déjà configuré pour cette personne, êtes-vous sûr de vouloir modifier ?")) {
          $(this).closest("tr").addClass("error");
          return;
        }
        else {
          $('select[name="'+duo.val()+'"]').closest("tr").addClass("error");
        }
      }
      duo.val(this.name).change();
    }
  }

  previous[this.name]=this.value;
});
$("#duoform").validate();
</script>
{% endblock %}

