{% extends 'organizer/base.html' %}

{% load volunteer %}
{% load keyvalue %}

{% block title %}{{ event.name }} - Planning
{% if eventschedule.name %}
  {{ eventschedule.name }}
{% else %}
  {{eventschedule.saved_at|date:"SHORT_DATETIME_FORMAT" }}
{% endif %} {% endblock %}

{% block content %}
<div name="eventschedule">
 <div class="row md-12" >
  <div class="col-6">
   {% if eventschedule.type != 'U' %}
   <span class="important">{{ eventschedule.type|schedule_type_name }}</span>
   {% endif %}
   {% if missings %}
   <div class="missing">
    <h3>Nombres de bénévoles manquants</h3>
    <ul>
     {% for slot, missing in missings.items %}
     <li>{{slot.start|date:"H:i" }} - {{slot.end|date:"H:i" }}: {{missing}}</li>
     {% endfor %}
    </ul>
   </div>
   {% endif %}
  </div>
  <div class="col-6 schedule-panel">
   {% if eventschedule.validated_at %}
   <h3>Validé le {{ eventschedule.validated_at|date:"SHORT_DATE_FORMAT" }} à {{ eventschedule.validated_at|date:"H:i:s" }}</h3>
   {% else %}
   <a href="{% url 'organizer:schedule_complete' event.slug eventschedule.id %}" class="btn btn-primary">Compléter ce planning automatiquement</a>
   <a href="{% url 'organizer:schedule_edit' event.slug eventschedule.id %}" class="btn btn-primary">Modifier ce planning</a>
   <a href="{% url 'organizer:schedule_validate' event.slug eventschedule.id %}" class="btn btn-success">Valider ce planning</a>
   {% if eventschedule.can_delete %}
   <form action="{% url 'organizer:schedule_delete' event.slug eventschedule.id %}" method="post" onsubmit="return confirm('Ce planning va être supprimé. Êtes-vous sûr ?');">
    {% csrf_token %}
    <input type="hidden" name="id" value="{{ eventschedule.id }}" />
    <button type="submit" class="btn btn-primary" alt="sauvegarder" value="update" name="action" id="save">
     Supprimer ce planning
    </button>
   </form>
   {% else %}
   Non supprimable
   {% endif %}
   {% endif %}
   <div class="form-check form-switch">
    <input type="checkbox" class="form-check-input" id="grouped-switch">
    <label for="grouped-switch" class="form-check-label">Grouper les créneaux sur le même poste.</label>
   </div>
  </div>
 </div>

 <div id="by_volunteer" class="table-responsive-sm">
  <h3>Par bénévole</h3> 
  <table class="table table-striped table-striped-columns table-hover table-bordered border-primary table-sm">
   <thead>
    <tr>
     <th scope="col"></th>
     <th scope="col"></th>
     {% for slot in slots %}
     <th scope="col">{{slot.start|date:"H:i" }} - {{slot.end|date:"H:i" }}: {{missing}}</th>
     {% endfor %}
    </tr>
   </thead>
   <tbody class="table-group-divider">
    {% for volunteer, volunteer_slots in by_volunteers.items %}
    <tr>
     <th scope="col">{{ volunteer.volunteer.lastname|upper }} {{ volunteer.volunteer.firstname|capfirst }}</th>
     <th scope="col">{{ volunteer.volunteer.phonenumber }}</th> 
     {% for slot in slots %}
      {% if slot in volunteer_slots %}
      {% with role=volunteer_slots|keyvalue:slot %}
      {% if role.role %}
      <td scope="col" class="slot-filled table-primary border-primary"
      data-repeat="{{ role.nb }}"
      data-first="{{ role.first }}"
      data-slot="{{ slot }}"
      >{{ role.role.name }} - {{ role.position }}</td>
      {% else %}
      <td scope="col" class="slot-empty table-success border-success">&nbsp;</td>
      {% endif %}
      {% endwith %}
      {% else %} 
      <td scope="col" class="slot-empty">&nbsp;</td>
      {% endif %}
     {% endfor %}
    </tr>
    {% endfor %}
   </tbody>
  </table>
 </div>

 <div id="by_role" class="table-responsive-sm">
  <h3>Par poste</h3> 
  <table class="table table-striped table-striped-columns table-hover table-bordered border-primary table-sm">
   <thead>
    <tr>
     <th></th>
     {% for slot in slots %}
     <th>{{slot.start|date:"H:i" }} - {{slot.end|date:"H:i" }}: {{missing}}</th>
     {% endfor %}
    </tr>
   </thead>
   <tbody class="table-group-divider">
    {% for role, role_slots in by_roles.items %}
     <tr>
      <td> {{ role.2 }} - {{ role.1 }}</td>
     {% for slot in slots %}
      {% if slot in role_slots %}
      {% with volunteer_entry=role_slots|keyvalue:slot %}
      {% with volunteer=volunteer_entry.volunteer %}
      {% if volunteer %}
      <td class="slot-filled table-primary"
      data-repeat="{{ volunteer_entry.nb }}"
      data-first="{{ volunteer_entry.first }}"
      data-slot="{{ slot }}"
      >{{ volunteer.volunteer.lastname|upper }} {{ volunteer.volunteer.firstname|capfirst }}</td>
      {% else %}
      <td class="slot-missing table-danger"><i class="bi bi-calendar-minus"></i></td>
      {% endif %}
      {% endwith %}
      {% endwith %}
      {% else %}
      <td class="slot-empty">&nbsp;</td>
      {% endif %}
     {% endfor %}
    {% endfor %}
   </tbody>
  </table>
 </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(document).ready(function() {
  $("#grouped-switch").on('change', function(e) {
    if ($(this).is(':checked')) {
      $(".slot-filled").each(function() {
        first=$(this).data("first");
        slot=$(this).data("slot");
        nb=$(this).data("repeat");
        if (first == slot) {
          $(this).attr('colspan', nb);
        }
        else {
          $(this).hide();
        }
      });
    }
    else {
      $(".slot-filled").each(function() {
        $(this).attr('colspan', 1);
        $(this).show();
      });
    }
  });
});
</script>
{% endblock %}


