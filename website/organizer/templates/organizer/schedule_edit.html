{% extends 'organizer/base.html' %}

{% load volunteer %}
{% load keyvalue %}
{% load widget %}

{% block title %}{{ event.name }} - Edition du planning
{% if eventschedule.name %}
  {{ eventschedule.name }}
{% else %}
  {{eventschedule.saved_at|date:"SHORT_DATETIME_FORMAT" }}
{% endif %} {% endblock %}

{% block content %}
<div name="eventschedule" class="ui-widget ui-helper-clearfix">

  <form action="{% url 'organizer:schedule_edit' event.slug eventschedule.id %}" method="post">
  {% csrf_token %}
  {% for hidden in form.hidden_fields %}
    {{ hidden }}
  {% endfor %}
  <div>
   <div class="row md-12" >
    <div class="col-6">
     <label for="{{ form.name.id_for_label }}" class="form-label">Nom</label>
     {{ form.name.errors }}
     {{ form.name|add_class:"form-control" }}
    </div>
    <div class="col-6">
     {{ form.no_update.errors }}
     <div class="form-check form-switch">
      {{ form.no_update|add_class:"form-check-input" }}
      <label for="{{ form.no_update.id_for_label }}" class="form-check-label">Créer une copie</label>
     </div>
     {{ form.as_base.errors }}
     <div class="form-check form-switch">
      {{ form.as_base|add_class:"form-check-input" }}
      <label for="{{ form.as_base.id_for_label }}" class="form-check-label">Utiliser cette version comme base pour le générateur</label>
     </div>
     <div class="form-check form-switch">
      {{ form.no_delete|add_class:"form-check-input" }}
      <label for="{{ form.no_delete.id_for_label }}" class="form-check-label">Ne pas supprimer</label>
     </div>
     <button type="submit" class="btn btn-primary" alt="sauvegarder" value="update" name="action" id="save">
       <i class="bi bi-calendar-check"></i> Sauvegarder
     </button>
     <a href="{% url 'organizer:schedule_detail' event.slug eventschedule.id %}" class="btn btn-primary">Visualiser ce planning</a>
    </div>
   </div>
  </div>

 <div id="volunteers" class="table-responsive-sm draggable ui-helper-reset ui-helper-clearfix">
  <h3>Bénévoles</h3> 
  <table class="table table-striped table-striped-columns table-hover table-bordered border-primary table-sm">
   <thead>
    <tr>
     <th scope="col"></th>
     {% for slot in slots %}
     <th scope="col">{{slot.start|date:"H:i" }} - {{slot.end|date:"H:i" }}: {{missing}}</th>
     {% endfor %}
    </tr>
   </thead>
   <tbody class="table-group-divider">
    {% for volunteer, volunteer_slots in volunteers.items %}
     {% with availables=volunteer_slots.availables %}
     {% with roles=volunteer_slots.roles %}
     <tr>
      <th scope="col">{{ volunteer.volunteer.lastname|upper }} {{ volunteer.volunteer.firstname|capfirst }}

      {% if volunteer.notes %}
       <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#notes-{{ volunteer.id }}" aria-expanded="false" aria-controls="notes-{{ volunteer.id }}">
        <i class="bi bi-file-earmark-plus"></i>
       </button>
       <div class="collapse" id="notes-{{ volunteer.id }}">
        <div class="card card-body">
         {{ volunteer.notes }}
        </div>
       </div>
      {% endif %}
      </th>
      {% for slot in slots %}
       {% if slot in availables %}
        <td scope="col" class="slot-filled slot 
        {% if slot in roles %}
        table-warning
        {% else %}
        table-success
        {% endif %}
        border-primary" data-schedule-volunteer-id="{{ volunteer.id }}" data-schedule-slot="{{ slot }}">

        {% if slot in roles %}
        {% with role=roles|keyvalue:slot %}
        <div class="volunteer-role">
         {{ role.role.name }}-{{ role.position}}
        </div>
        {% endwith %}
        {% else %}
          <div class="volunteer-in-slot volunteer" data-schedule-volunteer-id="{{volunteer.id }}" data-schedule-slot="{{ slot }}">
           {{ volunteer.volunteer.lastname|upper }} {{ volunteer.volunteer.firstname|capfirst }}
          <a href="#" title="Désaffecter" class="ui-icon ui-icon-trash">Désaffecter</a>
          </div>
        {% endif %}

        </td>
       {% else %} 
        <td scope="col" class="slot-empty">&nbsp;</td>
       {% endif %}
     {% endfor %}
     </tr>
     {% endwith %}
     {% endwith %}
    {% endfor %}
   </tbody>
  </table>
 </div>

 <div id="schedule" class="table-responsive-sm draggable ui-widget-content ui-state-default">
  {{ formset.non_form_errors }}
  {{ formset.management_form }}
  <h3>Planning</h3> 
  <table class="table table-hover table-bordered border-primary table-sm">
   <thead>
    <tr>
     <th></th>
     {% for slot in slots %}
     <th>{{slot.start|date:"H:i" }} - {{slot.end|date:"H:i" }}: {{missing}}</th>
     {% endfor %}
    </tr>
   </thead>
   <tbody class="table-group-divider">
    {% for role in roles %}
     <tr>
      <td> {{ role.0 }} - {{ role.1 }}</td>
     {% for slot in slots %}
      {% with form_index=role|make_tuple:slot %}

      {% if form_index in formset %}
        {% with form=formset|keyvalue:form_index %}
        <td class="slot-filled 
        {% if form.volunteer.value %}
          table-primary 
        {% else %}
          table-danger
        {% endif %}
        slot slot-schedule" data-schedule-slot="{{ form.instance.slot }}" data-schedule-role="{{ role.0.id }}-{{ role.1 }}" data-schedule-role-name="{{ role.0.name }}-{{ role.1 }}">

        {{ form }}

        {% if form.volunteer.value %}
         {% with volunteer=form.instance.volunteer.volunteer %}
          <div class="volunteer-in-slot volunteer" data-schedule-volunteer-id="{{ form.instance.volunteer.id }}" data-schedule-slot="{{ form.instance.slot }}">
          {{ volunteer.lastname|upper }} {{ volunteer.firstname|capfirst }}
          <a href="#" title="Désaffecter" class="ui-icon ui-icon-trash">Désaffecter</a>
          </div>
         {% endwith %}
        {% endif %}

        </td>
        {% endwith %}
      {% else %}
      <td class="slot-empty">&nbsp;</td>
      {% endif %}
      {% endwith %}
     {% endfor %}
    {% endfor %}
   </tbody>
  </table>
  </form>
 </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(document).ready(function() {
  let delete_click_event = function(event) {
    let $item = $(this);
    $target = $(event.target);

    if ($target.is("a.ui-icon-trash")) {
      free_volunteer($item);
    }
    return false;
  };

  let draggable_options = {
    cancel: "a.ui-icon",
    revert: "invalid",
    containment: "document",
    helper: "clone",
    cursor: "move",
  };

  $(".volunteer-in-slot").draggable(draggable_options);

  $("#volunteers .ui-icon-trash").hide();

  let make_droppable = function(droppable, callback, slot, volunteer = undefined) {
    let acceptable = volunteer === undefined ?
      '.volunteer-in-slot[data-schedule-slot="'+slot+'"]' :
      '.volunteer-in-slot[data-schedule-volunteer-id="'+volunteer+'"][data-schedule-slot="'+slot+'"]';
    droppable.droppable({
      accept: acceptable,
      classes: {
        "ui-droppable-active": "ui-state-highlight"
      },
      drop: function(event, ui) {
        callback(ui.draggable, droppable);
      },
    });
  }

  let volunteer_to_slot = function($item, to) {
    let old = $item.parent();
    let slot = $item.data("schedule-slot");
    let volunteer = $item.data("schedule-volunteer-id");

    volunteer_slot = $('#volunteers .slot[data-schedule-volunteer-id="'+volunteer+'"][data-schedule-slot="'+slot+'"]');
    volunteer_slot.removeClass('table-primary');
    volunteer_slot.addClass('table-warning');
    volunteer_slot.html('<div class="volunteer-role">'+
      to.data('schedule-role-name') +
      '</div>'
    );

    to.removeClass('table-danger');
    to.addClass('table-success');
    to.children("input[name$=-volunteer]").val(volunteer);

    $item.appendTo(to).show(10);
    $item.find("a").show(10);

    // Don't know why, but when item come from volunteers to schedule
    // he loose graggabilities and events...
    if (!old.hasClass('slot-schedule')) {
      $item.draggable(draggable_options);
      $item.on('click', delete_click_event);
    }
  }

  let affect_volunteer = function($item, to) {
    console.log("Affect volunteer " + $item);
    $item.hide(10, function() {
      let old = $item.parent();
      if (old.hasClass('slot-schedule')) {
        old.children("input[name$=-volunteer]").val('');
      }

      if (to.hasClass("slot-schedule")) {
        let old = $item.parent();
        affected = to.children(".volunteer-in-slot");
        if (affected.length > 0) {
          affected.hide(10, function() {
            if (old.hasClass('slot-schedule')) {
              volunteer_to_slot(affected, old);
            }
            else {
              free_volunteer(affected);
            }
          });
        }
        else if (old.hasClass('slot-schedule')) {
          old.removeClass('table-primary');
          old.addClass('table-danger');
        }
      }

      volunteer_to_slot($item, to);
    });
  };

  let free_volunteer = function($item, _) {
    console.log("Free volunteer " + $item);
    let slot = $item.data("schedule-slot");
    let volunteer = $item.data("schedule-volunteer-id");

    $item.hide(10, function() {
      $item.parent().removeClass('table-success');
      $item.parent().addClass('table-danger');

      $item.parent().children("input[name$=-volunteer]").val('');

      to = $('.slot[data-schedule-volunteer-id="'+volunteer+'"][data-schedule-slot="'+slot+'"]');
      to.html('') 
      $item.parent().addClass('table-success');
      $item.parent().removeClass('table-warning');
      $item.appendTo(to).show(10);
      $item.find('a').hide(10);
    });
  };

  $('#schedule .slot').each(function() {
    let slot = $(this).data("schedule-slot");

    make_droppable($(this), affect_volunteer, slot);
  });

  $('.volunteer-in-slot').on('click', delete_click_event);
});
</script>
{% endblock %}

