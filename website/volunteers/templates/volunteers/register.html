{% extends 'base.html' %}

{% load keyvalue %}

{% block title %}{{ event.name }} - Je suis bénévole !{% endblock %}

{% block content %}

{{ form.non_field_errors }}
<form action="{% url 'volunteers:register' event.slug %}" method="post" id="registrationform">
  {% csrf_token %}
  {% for hidden in form.hidden_fields %}
    {{ hidden }}
  {% endfor %}

  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <label for="{{ form.firstname.id_for_label }}" class="form-label"><i class="bi bi-person"></i> Prénom </label>
      {{ form.firstname.errors }}
      {{ form.firstname }}
    </div>
  
    <div class="col-md-6">
      <label for="{{ form.lastname.id_for_label }}" class="form-label"><i class="bi bi-person"></i> Nom </label>
      {{ form.lastname.errors }}
      {{ form.lastname }}
    </div>
  
    <div class="col-md-6">
      <label for="{{ form.email.id_for_label }}" class="form-label"><i class="bi bi-envelope"></i> Email </label>
      {{ form.email.errors }}
      {{ form.email }}
    </div>
  
    <div class="col-md-6">
      <label for="{{ form.phone.id_for_label }}" class="form-label"><i class="bi bi-telephone"></i> Numéro de téléphone </label>
      {{ form.phone.errors }}
      {{ form.phone }}
    </div>
  </div>

  <div class="row mb-4">
    <label class="form-label"> Si vous souhaitez être en binôme avec quelqu'un, vous pouvez indiquer ci-après son nom et son
    prénom. Nous essayerons autant que possible de respecter cette volonté ! </label>

    <div class="col-md-6">
      <label for="{{ form.friend_firstname.id_for_label }}" class="form-label"><i class="bi bi-person"></i> Prénom </label>
      {{ form.friend_firstname.errors }}
      {{ form.friend_firstname }}
    </div>
  
    <div class="col-md-6">
      <label for="{{ form.friend_lastname.id_for_label }}" class="form-label"><i class="bi bi-person"></i> Nom </label>
      {{ form.friend_lastname.errors }}
      {{ form.friend_lastname }}
    </div>
    
  </div>

  <div class="mb-4">
    <label class="form-label d-block"><i class="bi bi-clock"></i>Créneaux sur lesquels je suis disponible (plusieurs choix possibles)</label>
    {{ form.slots.errors }}
    <div id="timeSlots" class="row g-2">
    {% for slot in form.slots %}
      <div class="col-sm-6 col-md-4 col-lg-3">
        <div class="time-slot card h-100 border {% if slot.data.selected %}selected{% endif %}" id="div_{{ slot.id_for_label }}" onclick="toggleTimeSlot('{{ slot.id_for_label }}');">
          <div class="card-body d-flex align-items-center gap-2 py-2">
            <i class="bi bi-clock"></i><span>{{ slot.data.label.start|time:"H:i" }} - {{ slot.data.label.end|time:"H:i" }}</span>
            {{ slot.tag }}
          </div>
        </div>
      </div>
    {% endfor %}
    </div>
  </div>

  <div class="mb-4">
    <div class="col">
      <label for="{{ form.notes.id_for_label }}" class="form-label"><i class="bi bi-pass"></i> Si vous souhaitez nous laisser un petit message (préférence sur les horaires, allergies alimentaires, ....): </label>
      {{ form.notes.errors }}
      {{ form.notes }}
    </div>
  </div>

  {% if event.convention %}
  <div class="mb-4">
    <div class="col">
      {{ form.convention.errors }}
      {{ form.convention }} <label for="{{ form.convention.id_for_label }}" class="form-label">J'accepte la charte des signaleurs disponible <a href="{{ event.convention.url }}">ici</a></label>
    </div>
  </div>
  {% endif %}

  
  <div class="text-center">
    <button type="submit" class="btn btn-primary btn-lg px-5">
      Je suis bénévole !
    </button>
  </div>
</form>
{% endblock %}

{% block extra_script %}
<script>
selectedSlots = new Set();

function toggleTimeSlot(slotId) {
  const element = $(`#div_${slotId}`);
  const cb = $(`#${slotId}`);
  if (selectedSlots.has(slotId)) {
    selectedSlots.delete(slotId);
    element.removeClass('selected');
    cb.prop( "checked", false);
  } else {
    selectedSlots.add(slotId);
    element.addClass('selected');
    cb.prop( "checked", true);
  }
}

const validator = $('#registrationform').validate({
    rules: {
      "{{ form.slots.name }}": {
        required: true,
        minlength: 1
      }
    },
    messages: {
      "{{ form.slots.name }}": "Merci de sélectionner au moins un créneau."
    }
  });

</script>
{% endblock %}
